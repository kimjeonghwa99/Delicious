<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Delicious - 현재 위치 맛집</title>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Arial, sans-serif; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; }
    #map { width: 100%; height: 60vh; }
    #controls { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #eee; }
    button { padding: 10px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 8px; }
    button:active { transform: translateY(1px); }
    #list { padding: 12px 16px; }
    .item { padding: 10px 0; border-bottom: 1px dashed #eee; cursor: pointer; }
    .item.active { background: #f7f7f7; }
    .name { font-weight: 700; }
    .meta { color: #666; font-size: 13px; margin-top: 4px; }
    .error { color: #b00020; padding: 12px 16px; }
    .status { color: #333; padding: 12px 16px; }
  </style>

  <!-- 실제 배포 시: JavaScript 키 도메인 제한 필수 -->

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5cc113eed1ba23a0a9dca485916334e8&libraries=services&autoload=false"></script>

  <script>
    kakao.maps.load(function () {
      let map, ps, myLatLng;
      let markers = [];
      let info = new kakao.maps.InfoWindow({ zIndex: 10 });
      let lastData = [];
      let lastKeyword = '맛집';

      const $status = () => document.getElementById('status');
      const $error = () => document.getElementById('error');
      const $list = () => document.getElementById('list');

      function setStatus(text) { $status().textContent = text || ''; }
      function setError(text) { $error().textContent = text || ''; }

      function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
        info.close();
      }

      function setActiveList(index) {
        document.querySelectorAll('.item').forEach((el, i) => {
          el.classList.toggle('active', i === index);
        });
      }

      function openPlace(index) {
        const p = lastData[index];
        if (!p) return;

        const pos = new kakao.maps.LatLng(p.y, p.x);
        map.panTo(pos);

        const html = `
          <div style="padding:8px 10px; max-width:240px;">
            <div style="font-weight:700; margin-bottom:4px;">${p.place_name}</div>
            <div style="font-size:12px; color:#555;">${p.road_address_name || p.address_name || ''}</div>
            ${p.phone ? `<div style="font-size:12px; color:#555; margin-top:2px;">${p.phone}</div>` : ''}
          </div>
        `;
        info.setContent(html);
        info.open(map, markers[index]);

        setActiveList(index);
        // 리스트 아이템으로 스크롤 이동
        const item = document.getElementById(`item-${index}`);
        if (item) item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function renderList(data) {
        const el = $list();
        if (!data || data.length === 0) {
          el.innerHTML = '<div class="item">검색 결과가 없습니다.</div>';
          return;
        }

        el.innerHTML = data.map((p, idx) => `
          <div class="item" id="item-${idx}" onclick="window.__openPlace(${idx})">
            <div class="name">
              ${p.place_name}
              <span class="meta">(${p.distance ? `${p.distance}m` : '?m'})</span>
            </div>
            <div class="meta">${p.road_address_name || p.address_name || ''}</div>
            ${p.phone ? `<div class="meta">${p.phone}</div>` : ''}
          </div>
        `).join('');
      }

      function addPlaceMarkers(data) {
        clearMarkers();

        data.forEach((p, idx) => {
          const pos = new kakao.maps.LatLng(p.y, p.x);
          const marker = new kakao.maps.Marker({ map, position: pos });
          markers.push(marker);

          kakao.maps.event.addListener(marker, 'click', () => openPlace(idx));
        });
      }

      function searchKeyword(keyword, centerLatLng) {
        if (!ps) return;

        lastKeyword = keyword;
        const center = centerLatLng || myLatLng;
        if (!center) return;

        setError('');
        setStatus('검색 중...');
        ps.keywordSearch(keyword, (data, status) => {
          setStatus('');
          if (status !== kakao.maps.services.Status.OK) {
            setError('검색 실패: 키워드/반경/지역을 바꿔보세요.');
            renderList([]);
            clearMarkers();
            return;
          }
          lastData = data;
          addPlaceMarkers(data);
          renderList(data);
        }, {
          location: center,
          radius: 1000,
          sort: kakao.maps.services.SortBy.DISTANCE
        });
      }

      function initMap(lat, lng) {
        myLatLng = new kakao.maps.LatLng(lat, lng);

        map = new kakao.maps.Map(document.getElementById('map'), {
          center: myLatLng,
          level: 4
        });

        // 내 위치 마커(기본 마커로 둠: 필요시 커스텀 이미지 권장)
        new kakao.maps.Marker({ map, position: myLatLng });

        ps = new kakao.maps.services.Places();

        // 초기 검색
        searchKeyword('맛집', myLatLng);
      }

      // 외부 버튼 및 리스트 클릭에서 접근
      window.searchKeyword = (kw) => searchKeyword(kw, myLatLng);
      window.searchHere = () => searchKeyword(lastKeyword, map.getCenter());
      window.__openPlace = openPlace;

      if (!navigator.geolocation) {
        setError('이 브라우저는 위치 기능을 지원하지 않습니다.');
      } else {
        navigator.geolocation.getCurrentPosition(
          (pos) => initMap(pos.coords.latitude, pos.coords.longitude),
          () => setError('위치 권한이 필요합니다. 브라우저에서 위치 허용 후 새로고침 해주세요.')
        );
      }
    });
  </script>
</head>

<body>
  <header>
    <div><b>Delicious</b> — 현재 위치 기반 장소 찾기</div>
  </header>

  <div id="controls">
    <button onclick="searchKeyword('맛집')">맛집</button>
    <button onclick="searchKeyword('카페')">카페</button>
    <button onclick="searchKeyword('점심')">점심</button>
    <button onclick="searchKeyword('한식')">한식</button>
    <button onclick="searchHere()">이 지역에서 재검색</button>
  </div>

  <div id="map"></div>
  <div id="status" class="status"></div>
  <div id="error" class="error"></div>
  <div id="list"></div>
</body>
</html>
